<!DOCTYPE html>
<html>
<head>
    <title>Beyond the Uniform</title>
    <meta charset="utf-8">
    <link href="./src/netjsongraph.css" rel="stylesheet">
    <!-- theme can be easily customized via css -->
    <link href="./src/netjsongraph-theme.css" rel="stylesheet">
    <meta name="description" content="">
	<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1">
	<!-- <link rel="stylesheet" href="./css/normalize.css"> -->
	<link rel="stylesheet" href="./css/stylesheet.css">
    <link rel="stylesheet" href="./dist/css/selectize.default.css">
	<script src="js/jquery.min.js"></script>
	<script src="./dist/js/standalone/selectize.js"></script>
    <script src="./js/d3.min.js"></script>
</head>
<body>
    <h1> Beyond the Uniform </h1>
    <h4> By Conor Campbell, Melissa Plakyda, Michael Hauf, and Spencer Nelson </h4>
    <div class="buttons">
        <button class="m" value="FindTitles" onclick="buttonClicked('titles')">Find Your Job Title</button>
        <button class="m" value="FindCompanies" onclick="buttonClicked('companies')">Find Your Companies</button>
    </div>
    <div class="selectors" id="selectors">
    	<div class="control-group">
    		<label for="select-branch">Branch:</label>
    		<select id="select-branch" class="selectors-default" placeholder="Select a Warfare Specialty..." onchange="specialitySelected(this);">
    			<option value="" id="default">Select a Warfare Specialty...</option>
    			<option value="USMC">USMC</option>
    			<option value="Aviation">Aviation</option>
    			<option value="SWO">Surface Warefare Officer</option>
    			<option value="Submarines">Submarines</option>
    		</select>
    	</div>
        <div class="control-group">
    		<label for="select-yos">Years of Service:</label>
    		<select id="select-yos" class="selectors-default" placeholder="Select Years of Service..." onchange="yosSelected(this);">
                <option value="" id="default">Select a Warfare Specialty...</option>
    		</select>
    	</div>

        <div class="map" id="map">
        </div>

    	<script>
        var buttonSelected = "";
        var speciality = "";
        var yearsOfService = "";

        /* Populate years of service options. */
        for(var i=1; i<=35; i++){
            var select = document.getElementById("select-yos");
            var option = document.createElement("OPTION");
            if (i == 35) {
                select.options.add(option);
            	option.text = i + "+";
            	option.value = i;
            } else {
                select.options.add(option);
            	option.text = i;
            	option.value = i;
            }
        }

        /* Add selectize dropdown to these select html objects (Makes it look nice) */
    	$('#select-branch').selectize({
    		create: true,
    		sortField: {
    			field: 'text',
    			direction: 'asc'
    		},
    		dropdownParent: 'body'
    	});
        $('#select-yos').selectize({
    		create: true,
    		dropdownParent: 'body'
    	});

        /* This function should reset YOS and branch so the user needs to reenter them. */
        function resetSelections()
        {
            //TODO: figure this out
            console.log("CLICKED");
        }

        /* Clears any html from an object */
        function clear(elementID)
        {
            document.getElementById(elementID).innerHTML = "";
        }

        /* One of the top two buttons clicked. */
        function buttonClicked(value)
        {
            clear("map");
            resetSelections();
            buttonSelected = value;
            document.getElementById("selectors").style.visibility = "visible";
        }

        /* Function called when speciality selected. */
        function specialitySelected(option)
        {
            clear("map");
            speciality = option.options[option.selectedIndex].value;
            if (yearsOfService !=  "" && speciality != "")
            {
                drawMap();
            }
        }

        /* Function called when YOS selected. */
        function yosSelected(option)
        {
            clear("map");
            yearsOfService = option.options[option.selectedIndex].value;
            if (yearsOfService !=  "" && speciality != "")
            {
                drawMap();
            }
        }

        /* Use D3 to draw choropleth map that colors map according to YOS and speciality. */
        function drawMap()
        {
            //SVG setup
            var height = 400;
            var width = 500 * 1.21;

            // D3 Projection
            var projection = d3.geo.albersUsa()
			   .translate([width/2, height/2])    // translate to center of screen
			   .scale([750]);          // scale things down so see entire US

            // Define path generator
            var path = d3.geo.path()               // path generator that will convert GeoJSON to SVG paths
                .projection(projection);  // tell path generator to use albersUsa projection

            var svg = d3.select("#map")
                .append("svg")
                .attr("width", width)
                .attr("height", height)
                .append("g");

            // Append Div for tooltip to SVG
            var div = d3.select("#map")
    		    .append("div")
        		.attr("class", "tooltip")
        		.style("opacity", 0);

            d3.csv("USNALinkedInDataScott.csv", function(data) {
              d3.json("us-states.json", function(json) {
                  // Loop through each linkedin data value in the .csv file
                  var originals = 0;
                  var additions = 0;
                  var thisObject = {};
                  for (var i = 0; i < data.length; i++) {

                    var years = data[i].YearsService;
                    if (typeof thisObject[years] == "undefined")
                    {
                        thisObject[years] = 1;
                    }
                    else
                    {
                        thisObject[years]++;
                    }
                    var dataState = data[i].SimpleLocation;
                    var dataSpecialty = data[i].WarfareSpecialty;
                    //Need to change DC to match geoJSON
                    if (dataState == "D.C.")
                    {
                        dataState = "District of Columbia";
                    }

                  	//Find the corresponding state inside the GeoJSON
                  	for (var j = 0; j < json.features.length; j++)  {
                  		var jsonState = json.features[j].properties.name;
                  		if (dataState == jsonState && speciality == dataSpecialty) {
                      		// Copy the data value into the JSON
                            if (typeof json.features[j].properties.veteranPopulation == "undefined") {
                               json.features[j].properties.veteranPopulation = 1;
                            }
                            else
                            {
                                additions++;
                                json.features[j].properties.veteranPopulation++;
                            }

                      		// Stop looking through the JSON
                      		break;
                  		}
                  	}
                  }
                  console.log(thisObject);
                  var max_area = d3.max( json.features, function(d) { return d.properties.veteranPopulation });
                  var color = d3.scale.linear().domain([0, max_area]).range(['beige', 'red']);

                  svg.selectAll("path")
                  	.data(json.features)
                  	.enter()
                  	.append("path")
                  	.attr("d", path)
                  	.style("stroke", "#fff")
                  	.style("stroke-width", "1")
                  	.style("fill", function(d) {

                  	// Get data value
                  	var value = d.properties.veteranPopulation;
                    if (typeof value == "undefined")
                    {
                        return color(0);
                    }
                    else
                    {
                        return color(value);
                    }
                  })
                  .on("mouseover", function(d) {
                    var tempPop = 0;
                    if (typeof d.properties.veteranPopulation != "undefined")
                    {
                        tempPop = d.properties.veteranPopulation;
                    }
                    var displayString = d.properties.name + " Veteran Population: " + tempPop.toString();
                    div.transition()
                    	 .duration(200)
                         .style("opacity", .9);
                         div.text(displayString)
                         .style("left", (d3.event.pageX) + "px")
                         .style("top", (d3.event.pageY - 28) + "px");
              	  })

                  // fade out tooltip on mouse out
                  .on("mouseout", function(d) {
                      div.transition()
                         .duration(500)
                         .style("opacity", 0);
                  })
                  .on("click", function(d) {
                      //TODO: make pie chart show up once this works
                      console.log("CLICKED");
                  })
              });
            });
        }

        function drawPieChartIndustry()
        {
            //SVG setup
            var height = 400;
            var width = 500 * 1.21;

            // var svg = d3.select("#map"),
            // width = +svg.attr("width"),
            // height = +svg.attr("height"),
            // radius = Math.min(width, height) / 2,
            // g = svg.append("g").attr("transform", "translate(" + width / 2 + "," + height / 2 + ")");
            //TODO: fix this!!!!
            var svg = d3.select("#map")
                .append("svg")
                .attr("width", width)
                .attr("height", height)
                radius = Math.min(width, height) / 2,
                g = svg.append("g").attr("transform", "translate(" + width / 2 + "," + height / 2 + ")");

            var color = d3.scaleOrdinal(["#98abc5", "#8a89a6", "#7b6888", "#6b486b", "#a05d56", "#d0743c", "#ff8c00"]);

            var pie = d3.pie()
                .sort(null)
                .value(function(d) { return d.population; });

            var path = d3.arc()
                .outerRadius(radius - 10)
                .innerRadius(0);

            var label = d3.arc()
                .outerRadius(radius - 40)
                .innerRadius(radius - 40);

            d3.csv("data.csv", function(d) {
              d.population = +d.population;
              return d;
            }, function(error, data) {
              if (error) throw error;

              var arc = g.selectAll(".arc")
                .data(pie(data))
                .enter().append("g")
                  .attr("class", "arc");

              arc.append("path")
                  .attr("d", path)
                  .attr("fill", function(d) { return color(d.data.age); });

              arc.append("text")
                  .attr("transform", function(d) { return "translate(" + label.centroid(d) + ")"; })
                  .attr("dy", "0.35em")
                  .text(function(d) { return d.data.age; });
            });
        }
    	</script>
    </div>
</body>
</html>
